<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fight For Me ‚Äî Reader</title>
  <meta name="robots" content="noindex,nofollow" />

  <!-- ==== STORY GUARD ‚Äî tolerant and whitelist-based ==== -->
  <script>
  (function () {
    var OK = new Set(["reader.yumistories.com","yumistories.com","www.yumistories.com"]);
    if (!OK.has(location.hostname)) {
      location.replace("https://yumistories.com/book-keeper-secret-shelf");
      return;
    }
    try { if (top !== self) top.location = self.location; } catch (_) {}
    var r = document.referrer;
    if (r) {
      try {
        var rh = new URL(r).hostname;
        if (!OK.has(rh)) location.replace("https://yumistories.com/book-keeper-secret-shelf");
      } catch(_) { /* allow if parsing fails */ }
    }
  })();
  </script>

  <!-- ==== STYLES ==== -->
  <style>
    :root { --bg:#0f1115; --fg:#f2f2f2; --muted:#98a2b3; --zoom:1; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--fg);
      font:15px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif
    }
    .bar{
      position:sticky;top:0;z-index:10;display:flex;align-items:center;gap:.5rem;
      padding:.6rem .8rem;background:#151821cc;backdrop-filter:blur(8px);
      border-bottom:1px solid #232836
    }
    .title{font-weight:700;letter-spacing:.3px;margin-right:auto}
    .btn,.num{
      background:#1a1f2b;color:var(--fg);border:1px solid #2a3142;
      border-radius:10px;padding:.45rem .7rem;font:inherit;cursor:pointer
    }
    .btn:active{transform:translateY(1px)}
    .num{width:5.2rem;text-align:center}
    .wrap{max-width:1000px;margin:0 auto;padding:1rem .8rem 3rem}
    .page{
      position:relative;margin:0 auto 1.1rem;transform:scale(var(--zoom));
      transform-origin:top center;transition:transform .15s ease;min-height:60vh;
    }
    .page img{
      width:100%;height:auto;display:block;border-radius:8px;
      background:#0c0f14;box-shadow:0 10px 30px rgba(0,0,0,.35)
    }
    .page .tag{
      position:absolute;right:10px;bottom:10px;background:rgba(0,0,0,.55);
      color:#fff;font-size:12px;padding:.15rem .4rem;border-radius:6px
    }
    .muted{color:var(--muted)}
    .sep{width:1px;height:28px;background:#2a3142;margin:0 .4rem}
    .hide{display:none!important}
    .light{ --bg:#ffffff; --fg:#101418; --muted:#4b5563 }
    a.link{color:inherit;text-decoration:none;border-bottom:1px dashed #3b4255}
  </style>
</head>
<body>
  <!-- ==== TOP BAR ==== -->
  <div class="bar" role="toolbar" aria-label="Reader controls">
    <div class="title">Fight For Me</div>
    <button class="btn" id="prev" aria-label="Previous page">‚Üê Prev</button>
    <label class="muted" for="go">Page</label>
    <input class="num" id="go" type="number" min="1" value="1" inputmode="numeric" aria-label="Go to page">
    <span class="muted">/ <span id="total">‚Äî</span></span>
    <button class="btn" id="next" aria-label="Next page">Next ‚Üí</button>
    <div class="sep" aria-hidden="true"></div>
    <button class="btn" id="fit" aria-label="Fit to width">Fit</button>
    <button class="btn" id="zin" aria-label="Zoom in">+</button>
    <button class="btn" id="zout" aria-label="Zoom out">‚àí</button>
    <button class="btn" id="mode" aria-label="Toggle light/dark">üåô/‚òÄÔ∏è</button>
    <div style="margin-left:.4rem">
      <a class="link" href="/" aria-label="Back to Library">Library</a>
    </div>
  </div>

  <!-- ==== PAGES ==== -->
  <div id="pages" class="wrap" aria-live="polite"></div>

  <!-- ==== READER SCRIPT ==== -->
  <script>
  (function(){
    // === CONFIG (edit these to match your files) ===========================
    var DIR = "images/";          // images folder (relative to this file)
    var TOTAL = 246;              // total frames (1 cover + N pages)
    var TITLE_PREFIX = "FFM";     // FFM.jpg, FFM_001.jpg, FFM_002.jpg ...
    var EXT = ".jpg";             // file extension (".jpg" / ".webp" etc.)
    // ======================================================================

    // TEMP debug for image failures (remove when all good)
    window.__imgErrors = 0;

    // Show total
    document.getElementById("total").textContent = TOTAL;

    // Build pages
    var pagesEl = document.getElementById("pages");
    for (var i = 1; i <= TOTAL; i++) {
      var p = document.createElement("div");
      p.className = "page";
      p.dataset.page = i;

      var filename = (i === 1)
        ? (TITLE_PREFIX + EXT)
        : (TITLE_PREFIX + "_" + String(i - 1).padStart(3, "0") + EXT);

      var img = document.createElement("img");
      img.alt = "Fight For Me ‚Äî Page " + i;
      img.loading = "lazy";
      img.decoding = "async";
      img.dataset.src = DIR + filename;
      img.onerror = (function(container){
        return function(){
          container.classList.add("hide");
          window.__imgErrors++;
          if (window.__imgErrors === 1) {
            alert("Some pages failed to load. Check /fight-for-me/" + DIR + " filenames & case.");
          }
        };
      })(p);

      var tag = document.createElement("div");
      tag.className = "tag";
      tag.textContent = i;

      p.appendChild(img);
      p.appendChild(tag);
      pagesEl.appendChild(p);
    }

    // Lazy-load images
    var io = new IntersectionObserver(function(entries){
      entries.forEach(function(e){
        var img = e.target;
        if (e.isIntersecting && img && !img.src) {
          img.src = img.dataset.src;
          io.unobserve(img);
        }
      });
    }, { rootMargin: "800px 0px" });
    Array.prototype.forEach.call(document.querySelectorAll(".page img"), function(img){ io.observe(img); });

    // State + helpers
    var current = 1, zoom = 1;
    var go = document.getElementById("go");

    function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
    function setZoom(z){
      zoom = clamp(z, 0.6, 2.5);
      document.documentElement.style.setProperty("--zoom", zoom);
    }
    function scrollToPage(n, smooth){
      if (smooth === void 0) smooth = true;
      current = clamp(n, 1, TOTAL);
      go.value = current;
      var el = document.querySelector('.page[data-page="' + current + '"]');
      if (el) window.scrollTo({ top: el.offsetTop - 70, behavior: smooth ? "smooth" : "auto" });
      var url = new URL(location.href);
      url.searchParams.set("p", current);
      history.replaceState(null, "", url);
    }

    // Controls
    document.getElementById("prev").onclick = function(){ scrollToPage(current-1); };
    document.getElementById("next").onclick = function(){ scrollToPage(current+1); };
    document.getElementById("zin").onclick  = function(){ setZoom(zoom+0.15); };
    document.getElementById("zout").onclick = function(){ setZoom(zoom-0.15); };

    document.getElementById("fit").onclick = function(){
      var first = document.querySelector(".page img");
      var doFit = function(){
        var w = first.naturalWidth || first.getBoundingClientRect().width;
        if (!w) return setZoom(1);
        setZoom(document.getElementById("pages").clientWidth / w);
      };
      if (first.complete && first.naturalWidth) doFit();
      else {
        if (!first.src) first.src = first.dataset.src;
        first.addEventListener("load", doFit, {once:true});
      }
    };

    document.getElementById("mode").onclick = function(){
      document.body.classList.toggle("light");
    };
    go.onchange = function(){
      scrollToPage(parseInt(go.value || "1", 10));
    };

    // Page spy (updates the page number while scrolling)
    var spy = new IntersectionObserver(function(es){
      es.forEach(function(e){
        if (e.isIntersecting) {
          current = parseInt(e.target.parentElement.dataset.page, 10);
          go.value = current;
        }
      });
    }, { rootMargin:"-40% 0px -55% 0px" });
    Array.prototype.forEach.call(document.querySelectorAll(".page img"), function(img){ spy.observe(img); });

    // Keyboard shortcuts
    window.addEventListener("keydown", function(e){
      var k = e.key;
      if (k === "ArrowLeft")  scrollToPage(current-1);
      if (k === "ArrowRight") scrollToPage(current+1);
      if (k === "+")          setZoom(zoom+0.15);
      if (k === "-")          setZoom(zoom-0.15);
      if (k.toLowerCase() === "f") document.getElementById("fit").click();
    });

    // Init
    var startP = clamp(parseInt(new URLSearchParams(location.search).get("p") || "1", 10), 1, TOTAL);
    go.value = startP;
    setZoom(1);

    // Pre-warm first two pages
    var first = document.querySelector('.page[data-page="1"] img');
    if (first && !first.src) first.src = first.dataset.src;
    var second = document.querySelector('.page[data-page="2"] img');
    if (second && !second.src) second.src = second.dataset.src;

    scrollToPage(startP, false);

    // Protections (optional‚Äîkeep if you want)
    document.addEventListener("contextmenu", function(e){ e.preventDefault(); }, {capture:true});
    document.addEventListener("dragstart", function(e){ if (e.target && e.target.tagName==="IMG") e.preventDefault(); }, {capture:true});
    document.addEventListener("selectstart", function(e){ e.preventDefault(); }, {capture:true});
    document.addEventListener("keydown", function(e){
      var k = (e.key || "").toLowerCase();
      if ((e.ctrlKey||e.metaKey) && ["s","u","p"].includes(k)) { e.preventDefault(); e.stopPropagation(); }
      if ((e.ctrlKey||e.metaKey) && e.shiftKey && ["i","j","c"].includes(k)) { e.preventDefault(); e.stopPropagation(); }
    }, true);
  })();
  </script>

  <!-- ==== NON-SELECTABLE IMAGES ==== -->
  <style>
    html,body,img,.page{-webkit-user-select:none;user-select:none;-webkit-touch-callout:none}
    img{pointer-events:none}
  </style>
</body>
</html>
